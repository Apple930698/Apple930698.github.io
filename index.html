<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2027æ–°å¹´å€’è®¡æ—¶ - è·¨è®¾å¤‡å®æ—¶ç‰ˆ</title>
    <style>
        /* å…¨å±€æ ·å¼ */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Microsoft YaHei', sans-serif; }
        body { background: linear-gradient(135deg, #0f0c29, #302b63, #24243e); color: #fff; min-height: 100vh; overflow-x: hidden; flex-direction: column; align-items: center; justify-content: center; position: relative; display: flex; }
        .container { text-align: center; z-index: 10; padding: 20px; max-width: 800px; width: 100%; }
        h1 { font-size: 3.5rem; margin-bottom: 20px; text-shadow: 0 0 10px #ffcc00, 0 0 20px #ff9900; animation: glow 2s infinite alternate; }
        .subtitle { font-size: 1.5rem; margin-bottom: 20px; color: #ffcc00; text-shadow: 0 0 5px #ff9900; }
        .countdown { display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; margin-bottom: 30px; }
        .time-unit { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255, 204, 0, 0.3); border-radius: 10px; padding: 20px; min-width: 120px; box-shadow: 0 0 15px rgba(255, 204, 0, 0.2); transition: transform 0.3s; }
        .time-unit:hover { transform: translateY(-5px); background: rgba(255, 204, 0, 0.15); }
        .time-value { font-size: 3rem; font-weight: bold; color: #ffcc00; text-shadow: 0 0 10px #ff9900; }
        .time-label { font-size: 1rem; margin-top: 5px; color: #ccc; }
        .message { font-size: 1.2rem; margin-top: 20px; padding: 20px; background: rgba(255, 255, 255, 0.1); border-radius: 10px; line-height: 1.6; display: none; }
        .firework { position: absolute; width: 5px; height: 5px; border-radius: 50%; animation: explode 1s ease-out forwards; opacity: 0; }
        @keyframes glow { from { text-shadow: 0 0 10px #ffcc00, 0 0 20px #ff9900; } to { text-shadow: 0 0 20px #ffcc00, 0 0 30px #ff9900, 0 0 40px #ff6600; } }
        @keyframes explode { 0% { transform: scale(0); opacity: 1; } 100% { transform: scale(20); opacity: 0; } }
        .stars { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; }
        .star { position: absolute; width: 2px; height: 2px; background: white; border-radius: 50%; animation: twinkle 3s infinite; }
        @keyframes twinkle { 0%, 100% { opacity: 0.2; } 50% { opacity: 1; } }
        .footer { margin-top: 40px; font-size: 0.9rem; color: #aaa; z-index: 10; }
        .celebration { font-size: 1.8rem; margin-top: 30px; padding: 20px; background: linear-gradient(45deg, #ff3300, #ffcc00); border-radius: 15px; display: none; animation: pulse 1.5s infinite; font-weight: bold; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .btn { background: linear-gradient(45deg, #ff3300, #ff9900); color: white; border: none; padding: 12px 30px; border-radius: 25px; font-size: 1.1rem; cursor: pointer; margin-top: 20px; transition: all 0.3s; box-shadow: 0 5px 15px rgba(255, 51, 0, 0.4); }
        .btn:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(255, 51, 0, 0.6); }
        .btn:active { transform: translateY(1px); }
        .confetti { position: absolute; width: 10px; height: 10px; background: #ffcc00; animation: fall 5s linear infinite; z-index: 2; }
        @keyframes fall { to { transform: translateY(100vh) rotate(360deg); } }
        
        /* P2Pè¿æ¥é¢æ¿ */
        .p2p-panel {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 204, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin: 20px auto;
            max-width: 600px;
            text-align: left;
        }

        .p2p-panel h3 {
            margin-bottom: 15px;
            color: #ffcc00;
            text-align: center;
        }

        .p2p-panel input, .p2p-panel textarea {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 204, 0, 0.3);
            border-radius: 8px;
            color: white;
            font-family: monospace;
        }

        .p2p-panel button {
            background: linear-gradient(45deg, #00cc66, #00ff88);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 10px;
            margin-right: 10px;
            transition: all 0.3s;
        }

        .p2p-panel button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 136, 0.4);
        }

        .p2p-panel button.danger {
            background: linear-gradient(45deg, #ff3300, #ff6600);
        }

        .room-info {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-family: monospace;
            word-break: break-all;
            text-align: center;
        }

        .connection-status-bar {
            position: fixed;
            top: 10px;
            left: 10px;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
666;
        }

        .status-dot.connected { background: #00ff88; box-shadow: 0 0 8px #00ff88; }
        .status-dot.connecting { background: #ffcc00; animation: blink 1s infinite; }
        .status-dot.disconnected { background: #ff6666; }

        @keyframes blink { 50% { opacity: 0.3; } }

        .p2p-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .p2p-actions button {
            flex: 1;
            min-width: 120px;
        }

        .message-log {
            max-height: 100px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.2);
            padding: 8px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 0.85rem;
            font-family: monospace;
        }

        .message-log div {
            padding: 4px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .message-log div:last-child {
            border-bottom: none;
        }

        /* äº’åŠ¨é¢æ¿ï¼ˆè¿æ¥åæ˜¾ç¤ºï¼‰ */
        .interaction-panel {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 204, 0, 0.2);
            border-radius: 15px;
            padding: 20px;
            margin: 20px auto;
            max-width: 600px;
            min-height: 120px;
            position: relative;
            overflow: hidden;
            display: none;
        }

        .presence-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .presence-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #666;
            animation: pulse-dot 2s infinite;
        }

        .presence-dot.active {
            background: #00ff88;
            box-shadow: 0 0 10px #00ff88;
        }

        @keyframes pulse-dot {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        .notification-area {
            min-height: 40px;
            font-size: 0.95rem;
            color: #ffcc00;
            text-align: left;
            line-height: 1.5;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            margin-top: 10px;
                       border-radius: 50%;
            background: # max-height: 150px;
            overflow-y: auto;
        }

        .user-list {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .user-badge {
            background: rgba(255, 204, 0, 0.2);
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.85rem;
            border: 1px solid rgba(255, 204, 0, 0.3);
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .typing-indicator {
            font-size: 0.8rem;
            color: #888;
            font-style: italic;
            margin-top: 5px;
            min-height: 18px;
        }

        .interaction-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .icon-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 204, 0, 0.3);
            color: #ffcc00;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .icon-btn:hover {
            background: rgba(255, 204, 0, 0.2);
            transform: scale(1.05);
        }

        .welcome-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(45deg, #ff3300, #ffcc00);
            padding: 30px 50px;
            border-radius: 20px;
            font-size: 2rem;
            font-weight: bold;
            z-index: 2000;
            animation: welcomePop 1s ease-out forwards;
            pointer-events: none;
            display: none;
            text-align: center;
        }

        @keyframes welcomePop {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
        }

        @media (max-width: 600px) {
            h1 { font-size: 2.5rem; }
            .subtitle { font-size: 1.2rem; }
            .time-unit { min-width: 80px; padding: 15px; }
            .time-value { font-size: 2rem; }
            .p2p-panel, .interaction-panel { padding: 15px; }
        }
    </style>
</head>
<body>
    <!-- è¿æ¥çŠ¶æ€æ  -->
    <div class="connection-status-bar">
        <div class="status-dot disconnected" id="statusDot"></div>
        <span id="statusText">æœªè¿æ¥</span>
    </div>

    <!-- æ¬¢è¿åŠ¨ç”» -->
    <div class="welcome-message" id="welcomeMessage"></div>

    <!-- P2Pè¿æ¥é¢æ¿ -->
    <div class="p2p-panel" id="p2pPanel">
        <h3>ğŸ”— P2P è·¨è®¾å¤‡è¿æ¥ï¼ˆ2027è·¨å¹´ï¼‰</h3>
        
        <div id="roleSelection">
            <p style="text-align: center; margin-bottom: 15px;">
                è¯·é€‰æ‹©æ‚¨çš„è§’è‰²ï¼š
            </p>
            <div class="p2p-actions">
                <button onclick="createRoom()">ğŸ¯ æˆ‘æ˜¯å‘èµ·è€…ï¼ˆåˆ›å»ºæˆ¿é—´ï¼‰</button>
                <button onclick="showJoinForm()">ğŸ‘¥ æˆ‘æ˜¯åŠ å…¥è€…ï¼ˆè¾“å…¥æˆ¿é—´å·ï¼‰</button>
            </div>
        </div>

        <div id="createRoomForm" style="display: none;">
            <p>1. ç‚¹å‡»ç”Ÿæˆæˆ¿é—´å·</p>
            <button onclick="generateRoomId()">ç”Ÿæˆæˆ¿é—´å·</button>
            <div class="room-info" id="myRoomId" style="display: none;"></div>
            <p style="margin-top: 10px;">2. å°†æˆ¿é—´å·åˆ†äº«ç»™æœ‹å‹</p>
            <p style="font-size: 0.85rem; color: #aaa;">3. ç­‰å¾…æœ‹å‹åŠ å…¥...</p>
            <button class="danger" onclick="resetConnection()">å–æ¶ˆ</button>
        </div>

        <div id="joinRoomForm" style="display: none;">
            <p>è¾“å…¥æœ‹å‹ç»™ä½ çš„æˆ¿é—´å·ï¼š</p>
            <input type="text" id="friendRoomId" placeholder="ç²˜è´´æˆ¿é—´å·">
            <button onclick="joinRoom()">åŠ å…¥æˆ¿é—´</button>
            <button class="danger" onclick="resetConnection()">å–æ¶ˆ</button>
        </div>

        <div id="connectionLog" class="message-log" style="display: none;"></div>
    </div>

    <!-- äº’åŠ¨é¢æ¿ï¼ˆè¿æ¥åæ˜¾ç¤ºï¼‰ -->
    <div class="interaction-panel" id="interactionPanel">
        <div class="presence-indicator">
            <div class="presence-dot" id="presenceDot"></div>
            <span id="presenceText">ç­‰å¾…å¯¹æ–¹...</span>
        </div>
        
        <div class="user-list" id="userList"></div>
        
        <div class="notification-area" id="notificationArea">
            ğŸ’¡ è¿æ¥æˆåŠŸï¼å¯ä»¥å¼€å§‹äº’åŠ¨äº†ï¼
        </div>

        <div class="typing-indicator" id="typingIndicator"></div>

        <div class="interaction-buttons">
            <button class="icon-btn" onclick="sendData('ğŸ‘‹æ‰“æ‹›å‘¼')">ğŸ‘‹ æ‰“æ‹›å‘¼</button>
            <button class="icon-btn" onclick="sendData('ğŸ‰ 2027æ–°å¹´å¿«ä¹ï¼')">ğŸ‰ 2027æ–°å¹´å¿«ä¹</button>
            <button class="icon-btn" onclick="sendData('â¤ï¸çˆ±ä½ å“Ÿ')">â¤ï¸ çˆ±ä½ å“Ÿ</button>
            <button class="icon-btn" onclick="sendData('ğŸš€ä¸€èµ·å€’è®¡æ—¶')">ğŸš€ ä¸€èµ·å€’è®¡æ—¶</button>
            <button class="icon-btn" onclick="sendData('ğŸŠ ä¸€èµ·åº†ç¥')">ğŸŠ ä¸€èµ·åº†ç¥</button>
        </div>
    </div>

    <!-- ä¸»å€’è®¡æ—¶å®¹å™¨ -->
    <div class="container" id="mainContainer" style="display: none;">
        <h1>2027æ–°å¹´å€’è®¡æ—¶</h1>
        <div class="subtitle">è·ç¦»2027å¹´è¿˜æœ‰</div>
        
        <div class="countdown">
            <div class="time-unit">
                <div class="time-value" id="days">00</div>
                <div class="time-label">å¤©</div>
            </div>
            <div class="time-unit">
                <div class="time-value" id="hours">00</div>
                <div class="time-label">å°æ—¶</div>
            </div>
            <div class="time-unit">
                <div class="time-value" id="minutes">00</div>
                <div class="time-label">åˆ†é’Ÿ</div>
            </div>
            <div class="time-unit">
                <div class="time-value" id="seconds">00</div>
                <div class="time-label">ç§’</div>
            </div>
        </div>

        <button class="btn" id="celebrateBtn">ç«‹å³åº†ç¥</button>

        <div class="message" id="message">
            æ„¿2027å¹´å¸¦ç»™ä½ æ— å°½çš„å–œæ‚¦ã€å¥åº·çš„èº«ä½“ã€æˆåŠŸçš„äº‹ä¸šå’ŒçœŸæŒšçš„çˆ±æƒ…ã€‚ 
            æ–°å¹´å¿«ä¹ï¼Œä¸‡äº‹å¦‚æ„ï¼
        </div>

        <div class="celebration" id="celebration">
            ğŸ‰ æ–°å¹´å¿«ä¹ï¼2027å¹´å¤§å‰ï¼ ğŸ†
        </div>
    </div>

    <div class="footer" id="footer" style="display: none;">
        Â© 2026 æ–°å¹´å€’è®¡æ—¶ | P2Pè·¨è®¾å¤‡ç‰ˆ | ç¥æ‚¨2027æ–°å¹´å¿«ä¹
    </div>

    <!-- å¼•å…¥ PeerJS -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

    <script>
        // ==================== P2P è¿æ¥ç®¡ç† ====================
        
        let peer = null;
        let conn = null;
        let isP2PConnected = false;
        let myPeerId = null;
        let friendPeerId = null;

        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const logDiv = document.getElementById('connectionLog');
            if (!logDiv) return;
            
            const entry = document.createElement('div');
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            
            if (type === 'success') entry.style.color = '#00ff88';
            else if (type === 'error') entry.style.color = '#ff6666';
            else if (type === 'warning') entry.style.color = '#ffcc00';
            
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // æ›´æ–°çŠ¶æ€æ 
        function updateStatus(status, dotClass) {
            const statusText = document.getElementById('statusText');
            const statusDot = document.getElementById('statusDot');
            
            statusText.textContent = status;
            statusDot.className = `status-dot ${dotClass}`;
        }

        // åˆ›å»ºæˆ¿é—´ï¼ˆå‘èµ·è€…ï¼‰
        function createRoom() {
            document.getElementById('roleSelection').style.display = 'none';
            document.getElementById('createRoomForm').style.display = 'block';
            document.getElementById('connectionLog').style.display = 'block';
            
            updateStatus('åˆå§‹åŒ–...', 'connecting');
            log('æ­£åœ¨åˆå§‹åŒ– PeerJS...');

            // åˆå§‹åŒ– Peer
            peer = new Peer(null, {
                debug: 2,
                config: {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' }
                    ]
                }
            });

            peer.on('open', (id) => {
                myPeerId = id;
                log(`âœ… PeerID ç”Ÿæˆ: ${id}`, 'success');
                updateStatus('ç­‰å¾…åŠ å…¥', 'connecting');
            });

            peer.on('connection', (connection) => {
                conn = connection;
                friendPeerId = conn.peer;
                setupConnection();
                log(`ğŸ¤ æœ‹å‹å·²è¿æ¥: ${friendPeerId}`, 'success');
            });

            peer.on('error', (err) => {
                log(`âŒ é”™è¯¯: ${err.type}`, 'error');
                updateStatus('è¿æ¥é”™è¯¯', 'disconnected');
            });
        }

        // æ˜¾ç¤ºåŠ å…¥è¡¨å•
        function showJoinForm() {
            document.getElementById('roleSelection').style.display = 'none';
            document.getElementById('joinRoomForm').style.display = 'block';
            document.getElementById('connectionLog').style.display = 'block';
            
            updateStatus('åˆå§‹åŒ–...', 'connecting');
            log('æ­£åœ¨åˆå§‹åŒ– PeerJS...');

            // åˆå§‹åŒ– Peer
            peer = new Peer(null, {
                debug: 2,
                config: {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' }
                    ]
                }
            });

            peer.on('open', (id) => {
                myPeerId = id;
                log(`âœ… PeerID ç”Ÿæˆ: ${id}`, 'success');
                updateStatus('å‡†å¤‡è¿æ¥', 'connecting');
            });

            peer.on('error', (err) => {
                log(`âŒ é”™è¯¯: ${err.type}`, 'error');
                updateStatus('è¿æ¥é”™è¯¯', 'disconnected');
            });
        }

        // ç”Ÿæˆæˆ¿é—´å·
        function generateRoomId() {
            if (!myPeerId) {
                log('âŒ ç­‰å¾… Peer åˆå§‹åŒ–...', 'error');
                return;
            }
            
            const roomId = myPeerId;
            const roomIdDiv = document.getElementById('myRoomId');
            roomIdDiv.textContent = `æˆ¿é—´å·: ${roomId}`;
            roomIdDiv.style.display = 'block';
            
            // å¤åˆ¶åˆ°å‰ªè´´æ¿
            navigator.clipboard.writeText(roomId).then(() => {
                log('âœ… æˆ¿é—´å·å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
                showNotification('æˆ¿é—´å·å·²å¤åˆ¶ï¼Œåˆ†äº«ç»™æœ‹å‹å§ï¼');
            });
        }

        // åŠ å…¥æˆ¿é—´
        function joinRoom() {
            const roomId = document.getElementById('friendRoomId').value.trim();
            
            if (!roomId) {
                log('âŒ è¯·è¾“å…¥æˆ¿é—´å·', 'error');
                return;
            }

            if (!peer) {
                log('âŒ Peer æœªåˆå§‹åŒ–', 'error');
                return;
            }

            log(`æ­£åœ¨è¿æ¥æˆ¿é—´: ${roomId}`, 'warning');
            updateStatus('è¿æ¥ä¸­...', 'connecting');

            conn = peer.connect(roomId);
            friendPeerId = roomId;

            conn.on('open', () => {
                log(`âœ… è¿æ¥æˆåŠŸ!`, 'success');
                setupConnection();
            });

            conn.on('error', (err) => {
                log(`âŒ è¿æ¥å¤±è´¥: ${err}`, 'error');
                updateStatus('è¿æ¥å¤±è´¥', 'disconnected');
            });
        }

        // è®¾ç½®è¿æ¥å¤„ç†
        function setupConnection() {
            if (!conn) return;

            isP2PConnected = true;
            updateStatus('å·²è¿æ¥ P2P', 'connected');
            
            // æ˜¾ç¤ºäº’åŠ¨é¢æ¿
            document.getElementById('p2pPanel').style.display = 'none';
            document.getElementById('interactionPanel').style.display = 'block';
            document.getElementById('mainContainer').style.display = 'block';
            document.getElementById('footer').style.display = 'block';

            // æ›´æ–°UI
            document.getElementById('presenceDot').classList.add('active');
            document.getElementById('presenceText').textContent = 'P2P è¿æ¥å·²å»ºç«‹';
            
            // æ˜¾ç¤ºæ¬¢è¿
            showWelcomeMessage('ğŸ‰ è¿æ¥æˆåŠŸï¼');
            showNotification('âœ… P2P è¿æ¥å»ºç«‹ï¼Œæ•°æ®ç›´æ¥ä¼ è¾“ï¼Œä¸ç»è¿‡æœåŠ¡å™¨ï¼');

            // ç›‘å¬æ•°æ®
            conn.on('data', (data) => {
                handleReceivedData(data);
            });

            // ç›‘å¬è¿æ¥å…³é—­
            conn.on('close', () => {
                log('âŒ å¯¹æ–¹å·²æ–­å¼€è¿æ¥', 'error');
                updateStatus('è¿æ¥æ–­å¼€', 'disconnected');
                document.getElementById('presenceDot').classList.remove('active');
                document.getElementById('presenceText').textContent = 'è¿æ¥å·²æ–­å¼€';
                showNotification('ğŸ‘‹ å¯¹æ–¹å·²ç¦»å¼€');
                
                // é‡æ–°æ˜¾ç¤ºè¿æ¥é¢æ¿
                setTimeout(() => {
                    resetConnection();
                }, 2000);
            });

            // å¯åŠ¨å€’è®¡æ—¶ï¼ˆå¦‚æœè¿˜æ²¡å¯åŠ¨ï¼‰
            if (!window.countdownStarted) {
                initializeCountdown();
                window.countdownStarted = true;
            }
        }

        // å‘é€æ•°æ®
        function sendData(data) {
            if (!isP2PConnected || !conn) {
                showNotification('âŒ è¯·å…ˆå»ºç«‹è¿æ¥');
                return;
            }

            const message = {
                type: 'message',
                data: data,
                username: getUsername(),
                timestamp: Date.now()
            };

            conn.send(message);
            showNotification(`ğŸ’¬ æˆ‘: ${data}`, true);

            // æœ¬åœ°è§¦å‘çƒŸèŠ±
            for (let i = 0; i < 3; i++) {
                setTimeout(() => {
                    const x = Math.random() * window.innerWidth;
                    const y = Math.random() * window.innerHeight * 0.7;
                    createFirework(x, y);
                }, i * 150);
            }
        }

        // å¤„ç†æ¥æ”¶çš„æ•°æ®
        function handleReceivedData(data) {
            if (data.type === 'message') {
                showNotification(`ğŸ’¬ ${data.username}: ${data.data}`, true);
                triggerRemoteFireworks();
            } else if (data.type === 'typing') {
                const indicator = document.getElementById('typingIndicator');
                indicator.textContent = `${data.username} æ­£åœ¨è¾“å…¥...`;
                clearTimeout(window.typingTimeout);
                window.typingTimeout = setTimeout(() => {
                    indicator.textContent = '';
                }, 1500);
            } else if (data.type === 'celebrate') {
                showNotification(`ğŸŠ ${data.username} åœ¨åº†ç¥ï¼`, true);
                triggerRemoteFireworks();
            }
        }

        // é‡ç½®è¿æ¥
        function resetConnection() {
            if (conn) {
                conn.close();
                conn = null;
            }
            if (peer) {
                peer.destroy();
                peer = null;
            }
            
            isP2PConnected = false;
            myPeerId = null;
            friendPeerId = null;

            // é‡ç½®UI
            document.getElementById('p2pPanel').style.display = 'block';
            document.getElementById('roleSelection').style.display = 'block';
            document.getElementById('createRoomForm').style.display = 'none';
            document.getElementById('joinRoomForm').style.display = 'none';
            document.getElementById('connectionLog').style.display = 'none';
            document.getElementById('interactionPanel').style.display = 'none';
            document.getElementById('mainContainer').style.display = 'none';
            document.getElementById('footer').style.display = 'none';
            
            updateStatus('æœªè¿æ¥', 'disconnected');
            log('è¿æ¥å·²é‡ç½®', 'warning');
        }

        // ==================== é€šçŸ¥ç³»ç»Ÿ ====================
        
        function showNotification(message, highlight = false) {
            const notificationArea = document.getElementById('notificationArea');
            if (!notificationArea) return;

            const time = new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            const div = document.createElement('div');
            div.textContent = `[${time}] ${message}`;
            div.style.marginBottom = '5px';
            
            if (highlight) {
                div.style.color = '#ff9900';
                div.style.fontWeight = 'bold';
            }

            notificationArea.insertBefore(div, notificationArea.firstChild);
            
            while (notificationArea.children.length > 8) {
                notificationArea.removeChild(notificationArea.lastChild);
            }
        }

        function showWelcomeMessage(text) {
            const welcomeMessage = document.getElementById('welcomeMessage');
            welcomeMessage.textContent = text;
            welcomeMessage.style.display = 'block';
            setTimeout(() => {
                welcomeMessage.style.display = 'none';
            }, 1500);
        }

        function triggerRemoteFireworks() {
            for (let i = 0; i < 5; i++) {
                setTimeout(() => {
                    const x = Math.random() * window.innerWidth;
                    const y = Math.random() * window.innerHeight * 0.7;
                    createFirework(x, y);
                }, i * 100);
            }
            createConfetti();
        }

        // ==================== ç”¨æˆ·ä¿¡æ¯ ====================
        
        function getUsername() {
            let username = localStorage.getItem('countdown_username');
            if (!username) {
                const adjectives = ['å¼€å¿ƒ', 'å¿«ä¹', 'å¹¸ç¦', 'ç”œèœœ', 'æ¸©æš–', 'é—ªè€€', 'å‹‡æ•¢', 'æ¸©æŸ”'];
                const nouns = ['å°ç†Š', 'æ˜Ÿæ˜Ÿ', 'æœˆäº®', 'å¤ªé˜³', 'ç³–æœ', 'å½©è™¹', 'çƒŸèŠ±', 'å¤©ä½¿'];
                username = adjectives[Math.floor(Math.random() * adjectives.length)] + 
                          nouns[Math.floor(Math.random() * nouns.length)];
                localStorage.setItem('countdown_username', username);
            }
            return username;
        }

        // ==================== å€’è®¡æ—¶é€»è¾‘ ====================
        
        function initializeCountdown() {
            // ç›®æ ‡æ—¶é—´ï¼š2027å¹´1æœˆ1æ—¥ 00:00:00
            const TARGET_DATE = new Date('2027-01-01T00:00:00');
            let targetTime = TARGET_DATE.getTime();

            function createStars() {
                const starsContainer = document.createElement('div');
                starsContainer.className = 'stars';
                starsContainer.id = 'stars';
                document.body.appendChild(starsContainer);

                for (let i = 0; i < 100; i++) {
                    const star = document.createElement('div');
                    star.classList.add('star');
                    star.style.left = Math.random() * 100 + '%';
                    star.style.top = Math.random() * 100 + '%';
                    star.style.animationDelay = Math.random() * 3 + 's';
                    starsContainer.appendChild(star);
                }
            }

            function createFirework(x, y) {
                const colors = ['#ffcc00', '#ff6600', '#ff0066', '#00ccff', '#00ff99'];
                const color = colors[Math.floor(Math.random() * colors.length)];
                for (let i = 0; i < 30; i++) {
                    const firework = document.createElement('div');
                    firework.classList.add('firework');
                    firework.style.backgroundColor = color;
                    firework.style.left = x + 'px';
                    firework.style.top = y + 'px';
                    const angle = Math.random() * Math.PI * 2;
                    const distance = 50 + Math.random() * 100;
                    const tx = Math.cos(angle) * distance;
                    const ty = Math.sin(angle) * distance;
                    firework.style.transform = `translate(${tx}px, ${ty}px)`;
                    document.body.appendChild(firework);
                    setTimeout(() => firework.parentNode && firework.parentNode.removeChild(firework), 1000);
                }
            }

            function createConfetti() {
                const colors = ['#ffcc00', '#ff3300', '#00ccff', '#00ff99', '#ff0066'];
                for (let i = 0; i < 50; i++) {
                    const confetti = document.createElement('div');
                    confetti.classList.add('confetti');
                    confetti.style.left = Math.random() * 100 + '%';
                    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.animationDelay = Math.random() * 5 + 's';
                    confetti.style.animationDuration = (3 + Math.random() * 4) + 's';
                    document.body.appendChild(confetti);
                    setTimeout(() => confetti.parentNode && confetti.parentNode.removeChild(confetti), 8000);
                }
            }

            function updateCountdown() {
                const now = Date.now();
                const diff = targetTime - now;
                
                if (diff <= 0) {
                    ['days','hours','minutes','seconds'].forEach(id => document.getElementById(id).textContent = '00');
                    document.getElementById('message').style.display = 'block';
                    document.getElementById('celebration').style.display = 'block';
                    document.getElementById('celebrateBtn').style.display = 'none';
                    
                    setInterval(() => {
                        const x = Math.random() * window.innerWidth;
                        const y = Math.random() * window.innerHeight * 0.7;
                        createFirework(x, y);
                    }, 300);
                    createConfetti();
                    return false;
                }
                
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                
                document.getElementById('days').textContent = days.toString().padStart(2, '0');
                document.getElementById('hours').textContent = hours.toString().padStart(2, '0');
                document.getElementById('minutes').textContent = minutes.toString().padStart(2, '0');
                document.getElementById('seconds').textContent = seconds.toString().padStart(2, '0');
                
                return true;
            }

            function startCountdown() {
                let lastUpdate = Date.now();
                function loop() {
                    const now = Date.now();
                    const elapsed = now - lastUpdate;
                    if (elapsed > 1100) {
                        const correction = elapsed - 1000;
                        targetTime += correction;
                    }
                    lastUpdate = now;
                    if (updateCountdown()) {
                        requestAnimationFrame(loop);
                    }
                }
                requestAnimationFrame(loop);
            }

            function randomFireworks() {
                setInterval(() => {
                    if (Math.random() > 0.7) {
                        const x = Math.random() * window.innerWidth;
                        const y = Math.random() * window.innerHeight * 0.7;
                        createFirework(x, y);
                    }
                }, 2000);
            }

            createStars();
            if (Date.now() >= targetTime) {
                document.getElementById('celebrateBtn').textContent = 'ç°åœ¨åº†ç¥';
                updateCountdown();
            } else {
                startCountdown();
                randomFireworks();
            }

            document.getElementById('celebrateBtn').addEventListener('click', function() {
                document.getElementById('message').style.display = 'block';
                document.getElementById('celebration').style.display = 'block';
                
                // å‘é€åº†ç¥é€šçŸ¥
                if (isP2PConnected && conn) {
                    conn.send({
                        type: 'celebrate',
                        username: getUsername(),
                        timestamp: Date.now()
                    });
                }
                
                for (let i = 0; i < 5; i++) {
                    setTimeout(() => {
                        const x = Math.random() * window.innerWidth;
                        const y = Math.random() * window.innerHeight * 0.7;
                        createFirework(x, y);
                    }, i * 200);
                }
                createConfetti();
            });

            document.addEventListener('click', function(e) {
                createFirework(e.clientX, e.clientY);
            });
        }

        // é¡µé¢å¸è½½æ¸…ç†
        window.addEventListener('beforeunload', () => {
            if (conn) conn.close();
            if (peer) peer.destroy();
        });
    </script>
</body>
</html>